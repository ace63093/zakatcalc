{% extends "base.html" %}

{% block title %}Where to Give Your Zakat — Muslim Charity Directory{% endblock %}

{% block head %}
<meta name="description" content="Find trusted, government-registered Muslim charities worldwide to give your Zakat. Covers Canada, USA, UK, Australia, and more.">
<link rel="stylesheet" href="{{ url_for('static', filename='css/charities.css') }}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="content-section charities-header">
        <h1>Where to Give Your Zakat</h1>
        <p class="charities-subtitle">Government-registered Muslim charities across {{ country_options | length }} countries.</p>
    </div>

    <div class="charities-notice">
        All organizations listed are government-registered charities in their respective countries.
        Listing here is not an endorsement — always verify registration status directly before donating.
    </div>

    <!-- Country tabs (scrollable) -->
    <div class="charities-tabs-wrap">
        <div class="charities-tabs" role="tablist">
            <button class="charities-tab" data-country="all" role="tab" aria-selected="false">All</button>
            {% for opt in country_options %}
            <button class="charities-tab" data-country="{{ opt.code }}" role="tab" aria-selected="false">
                {{ opt.flag }} {{ opt.label }}
            </button>
            {% endfor %}
        </div>
    </div>

    <!-- Search -->
    <div class="charities-search-wrap">
        <input type="search" id="charitiesSearch" class="charities-search"
               placeholder="Search by name…" aria-label="Search charities" autocomplete="off">
    </div>

    <!-- No results -->
    <p class="charities-no-results" id="charitiesNoResults" hidden>No charities match your search.</p>

    <!-- Card grid -->
    <div class="charities-grid" id="charitiesGrid">
        {% for charity in charities %}
        <div class="charity-card {% if charity.featured %}charity-card--featured{% endif %}"
             data-country="{{ charity.country }}"
             data-name="{{ charity.name | lower }}">

            <div class="charity-card__header">
                <h2 class="charity-card__name">{{ charity.name }}</h2>
                {% if charity.featured %}
                <span class="charity-featured-badge">Featured</span>
                {% endif %}
            </div>

            <div class="charity-card__tags">
                {% for tag in charity.tags %}
                <span class="charity-tag charity-tag--{{ tag | lower | replace(' ', '-') }}">{{ tag }}</span>
                {% endfor %}
            </div>

            <p class="charity-card__desc">{{ charity.description }}</p>

            <p class="charity-card__reg">
                <span class="charity-reg-label">{{ charity.registration_label }}:</span>
                {% if charity.registration_number %}
                <span class="charity-reg-num">{{ charity.registration_number }}</span>
                {% else %}
                <span class="charity-reg-num charity-reg-num--unknown">See website</span>
                {% endif %}
            </p>

            <div class="charity-card__footer">
                <a href="{{ charity.website }}" class="charity-website-link"
                   target="_blank" rel="noopener noreferrer">Visit Website ↗</a>
                <a href="{{ charity.donate_url }}" class="charity-donate-btn"
                   target="_blank" rel="noopener noreferrer">Donate</a>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="charities-disclaimer">
        <strong>Disclaimer:</strong> This directory is for informational purposes only and does not constitute
        a religious ruling on Zakat eligibility. For guidance on eligible Zakat recipients, consult a qualified Islamic scholar.
    </div>
</div>

<script>
(function () {
    'use strict';
    var grid = document.getElementById('charitiesGrid');
    var noResults = document.getElementById('charitiesNoResults');
    var searchInput = document.getElementById('charitiesSearch');
    var tabs = document.querySelectorAll('.charities-tab');
    var activeCountry = 'all';

    function applyFilters() {
        var query = searchInput.value.trim().toLowerCase();
        var visible = 0;
        grid.querySelectorAll('.charity-card').forEach(function (card) {
            var countryMatch = activeCountry === 'all' || card.dataset.country === activeCountry;
            var nameMatch = !query || card.dataset.name.includes(query);
            card.hidden = !(countryMatch && nameMatch);
            if (!card.hidden) visible++;
        });
        noResults.hidden = visible > 0;
    }

    function activateTab(country) {
        tabs.forEach(function (t) {
            var match = t.dataset.country === country;
            t.classList.toggle('active', match);
            t.setAttribute('aria-selected', match ? 'true' : 'false');
            if (match) t.scrollIntoView({ block: 'nearest', inline: 'center' });
        });
        activeCountry = country;
        applyFilters();
    }

    tabs.forEach(function (tab) {
        tab.addEventListener('click', function () { activateTab(tab.dataset.country); });
    });

    searchInput.addEventListener('input', applyFilters);

    // Pre-select country from server-side geo hint, fallback to "all"
    var userCountry = {{ user_country | tojson }};
    activateTab(userCountry || 'all');
}());
</script>
{% endblock %}
